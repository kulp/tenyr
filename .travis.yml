addons: &def_addons
  artifacts:
    paths:
      - $(ls -1 $(${MAKE} showbuilddir)/*.{gz,zip} | tr "\n" :)
      - $(find . -name 'core.*' -o -name 'core' | tr "\n" :)
    target_paths:
      - build/$TRAVIS_BUILD_NUMBER/$TRAVIS_JOB_NUMBER
      - version/$(git describe --always --tags --match 'v?.?.?*' $TRAVIS_COMMIT)
env:
  global:
    - DEPSSRC=$HOME/local
    - C_INCLUDE_PATH=$DEPSSRC/include
    - LIBRARY_PATH=$DEPSSRC/lib
    - LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$LIBRARY_PATH"
    - LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$DEPSSRC/lib/x86_64-linux-gnu"
    - PATH="$PATH:$DEPSSRC/bin"
matrix:
  include:
    - language: c
      os: windows
      env:
        - PLATFORM=mingw BITS=64 HOST=x86_64
        - CHECK_RULE=check_sw GCOV=  JIT=0 SDL=0
        - PKG_RULE=zip
sudo: false
before_cache:
  - |-
    case $TRAVIS_OS_NAME in
      windows)
        # https://unix.stackexchange.com/a/137322/107554
        $msys2 pacman --sync --clean --noconfirm
        ;;
    esac
cache:
  directories:
    - $HOME/AppData/Local/Temp/chocolatey
    - /C/tools/msys64
before_script:
  - mkdir -p $DEPSSRC
  - . scripts/install_msys2.sh
  - if [[ $JIT != 0 ]] ; then ./scripts/build-lightning.sh 2.1.3 $DEPSSRC ; fi
  - if [[ $TRAVIS_OS_NAME = linux ]] ; then curl -s 'http://dl.tenyr.info/deps/iverilog-s20140801-139-gaf85d44-x86_64-linux-binaries-0.10.0.tar.gz' | tar -C $DEPSSRC -zx ; fi
  - if [[ $PLATFORM = mingw ]] ; then ${MAKE} download-all-sdl2 ; fi
  - if [[ $PLATFORM = mingw ]] ; then sed "s#{{{}}}#z:$(echo $PWD/3rdparty/sdl2/$HOST-w64-mingw32/bin | sed 's#/#\\\\\\\\#g')#" scripts/winepath.reg > scripts/winepath2.reg ; wine regedit scripts/winepath2.reg ; fi
  - if [[ $TRAVIS_OS_NAME = osx ]] ; then brew install bison ; BISONS=(/usr/local/Cellar/bison/*/bin/bison) ; export BISON="${BISONS[${#BISONS[@]}-1]}" ; fi
  # implement Coverity Scan with before_script instead of addons.coverity_scan
  # to work around too-early quota check by the coverity_scan addon
  - if [[ -n $COVERITY_SCAN_PROJECT_NAME ]] ; then curl -s 'https://scan.coverity.com/scripts/travisci_build_coverity_scan.sh' | bash || true ; fi
script:
  - ${MAKE} V=1 all
  - ${MAKE} $CHECK_RULE
  - ${MAKE} local-install
  - ${MAKE} $PKG_RULE
after_success:
  - |
    if [[ -n $GCOV ]] ; then
        bash <(curl -s https://codecov.io/bash) -f $(${MAKE} showbuilddir)/coverage.info.src -f $(${MAKE} showbuilddir)/coverage.info.vpi
    fi
notifications:
  irc:
    channels:
      - "irc.freenode.org#tenyr"
    use_notice: true
    skip_join: true
